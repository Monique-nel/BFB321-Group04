<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mzanzi Market Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light">

    <header id="pageTop">
      <nav
        class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm sticky-top py-2"
      >
        <div class="container-fluid px-4">
          <!-- Left side: Logo + Links -->
          <a class="navbar-brand d-flex align-items-center me-3" href="/">
            <img
              src="{{ url_for('static', filename='images/Logo.png') }}"
              alt="Mzanzi Market"
              height="100"
              class="me-2"
            />
          </a>

          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Left-aligned links (next to logo) -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link fw-semibold fs-5 active" href="/"
                  >Home</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-semibold fs-5" href="events"
                  >Upcoming Events</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link fw-semibold fs-5" href="vendors"
                  >Vendor Community</a
                >
              </li>
            </ul>

            <!-- Right side: Search + User -->
            <div class="d-flex align-items-center">
              <!-- Search -->
              <form class="d-flex me-3" role="search">
                <input
                  class="form-control me-2 rounded-pill px-3 py-1 fs-5"
                  type="search"
                  placeholder="Search..."
                  aria-label="Search"
                />
                <button
                  class="btn btn-outline-light rounded-pill px-3 py-1 fs-5"
                  type="submit"
                >
                  Search
                </button>
              </form>

              <!-- User section -->
              <ul class="navbar-nav d-flex align-items-center mb-0">
                <li class="nav-item">
                  
                  {% if session.get('user_id') %}
                    <a
                      class="nav-link d-flex align-items-center fw-semibold fs-5"
                      href="{{ url_for('userpage') }}"
                    >
                      <img
                        src="{{ url_for('static', filename='images/usericon.png')}}"
                        alt="User"
                        height="30"
                        class="me-1 rounded-circle border border-light p-1"
                      />
                      <span>{{ session['username'] }}</span>
                    </a>

                  {% else %}
                    <a
                      class="nav-link d-flex align-items-center fw-semibold fs-5"
                      href="{{ url_for('login') }}"
                    >
                      <img
                        src="{{ url_for('static', filename='images/usericon.png')}}"
                        alt="User"
                        height="30"
                        class="me-1 rounded-circle border border-light p-1"
                      />
                      <span>Sign In</span>
                    </a>
                  {% endif %}

                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main>
      <div class="container my-5">
        <div class="container py-5">

            <div class="row mb-3">
                <div class="col-12">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                                    <i class="bi bi-info-circle-fill me-2"></i> {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
            </div>

            <div class="row g-4">

                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                                <div class="d-inline-block p-3 rounded-circle bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-person-circle display-4"></i>
                                </div>
                            </div>
                            <h4 class="fw-bold mb-1">{{ user['Username'] }}</h4>
                            <span class="badge bg-success rounded-pill mb-4">{{ user['Classification'] }}</span>

                            <div class="text-start d-grid gap-3">
                                <div class="p-3 bg-light rounded d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Username</small>
                                        <div class="fw-semibold">{{ user['Username'] }}</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="modal" data-bs-target="#editUsernameModal">
                                        <i class="bi bi-pencil-square fs-5"></i>
                                    </button>
                                </div>

                                <div class="p-3 bg-light rounded d-flex justify-content-between align-items-center">
                                    <div class="text-truncate pe-2">
                                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Email</small>
                                        <div class="fw-semibold text-truncate">{{ user['Email'] }}</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="modal" data-bs-target="#editEmailModal">
                                        <i class="bi bi-pencil-square fs-5"></i>
                                    </button>
                                </div>

                                <div class="p-3 bg-light rounded d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Password</small>
                                        <div class="fw-semibold">••••••••</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="modal" data-bs-target="#editPasswordModal">
                                        <i class="bi bi-pencil-square fs-5"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-top">
                                <h6 class="text-muted text-uppercase small fw-bold mb-3">Account Actions</h6>
                                
                                <div class="d-grid gap-3">
                                    <a href="{{ url_for('logout') }}" class="btn btn-lg btn-secondary">
                                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#deleteProfileModal">
                                        <i class="bi bi-trash3 me-2"></i> Delete Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="d-flex flex-column gap-4">

                        {# --- LOGIC START --- #}
                        
                        {# 1. VENDOR VIEW #}
                        {% if user['Classification'] == 'Vendor' %}
                            <div> 
                                
                                <div class="card shadow-lg border-0 overflow-hidden mb-4">
                                  <div class="row g-0">
                                      
                                      <div class="col-md-4 bg-light border-end d-flex flex-column align-items-center justify-content-center p-4 text-center">
                                          
                                          <div class="mb-3">
                                              {% if vendor['VendorLogo'] %}
                                                  <img src="data:image/jpeg;base64,{{ vendor['VendorLogo'] }}" 
                                                          class="rounded-circle img-fluid border border-3 border-success p-1" 
                                                          style="width: 120px; height: 120px; object-fit: cover;" alt="Vendor Logo">
                                              {% else %}
                                                  <div class="bg-white rounded-circle d-flex align-items-center justify-content-center border border-3 border-success p-1" style="width: 120px; height: 120px;">
                                                      <i class="bi bi-shop text-success" style="font-size: 3rem;"></i>
                                                  </div>
                                              {% endif %}
                                          </div>
                                          
                                          <h5 class="fw-bold mb-1">{{ vendor['VendorName'] }}</h5>
                                          <span class="badge bg-success mb-3">{{ vendor['VendorOfferingType'] or 'General Vendor' }}</span>

                                          <div class="d-flex gap-2 justify-content-center mt-2">
                                              {% if vendor['VendorWebsite'] %}
                                                  <a href="{{ vendor['VendorWebsite'] }}" target="_blank" class="btn btn-sm btn-outline-dark rounded-circle" title="Website">
                                                      <i class="bi bi-globe"></i>
                                                  </a>
                                              {% endif %}
                                              {% if vendor['VendorFacebook'] %}
                                                  <a href="{{ vendor['VendorFacebook'] }}" target="_blank" class="btn btn-sm btn-outline-primary rounded-circle" title="Facebook">
                                                      <i class="bi bi-facebook"></i>
                                                  </a>
                                              {% endif %}
                                              {% if vendor['VendorInstagram'] %}
                                                  <a href="{{ vendor['VendorInstagram'] }}" target="_blank" class="btn btn-sm btn-outline-danger rounded-circle" title="Instagram">
                                                      <i class="bi bi-instagram"></i>
                                                  </a>
                                              {% endif %}
                                          </div>
                                      </div>

                                      <div class="col-md-8 p-4 d-flex flex-column justify-content-between">
                                          
                                          <div>
                                              <h5 class="text-uppercase text-muted fw-bold small mb-2">About the Stall</h5>
                                              <p class="card-text small text-muted mb-3">
                                                  {{ vendor['VendorStallDescription'] or "This vendor has not added a description yet." }}
                                              </p>

                                              {% if vendor['VendorDescriptionPicture'] %}
                                                  <div class="mb-3 rounded overflow-hidden border shadow-sm" style="max-height: 150px;">
                                                      <img src="data:image/jpeg;base64,{{ vendor['VendorDescriptionPicture'] }}" 
                                                          class="w-100 h-100 object-fit-cover" alt="Stall Picture">
                                                  </div>
                                              {% endif %}
                                          </div>

                                          <div>
                                              <h5 class="text-uppercase text-muted fw-bold small mb-2">Location & Contact</h5>
                                              <ul class="list-unstyled small text-muted mb-0">
    
                                                <li class="mb-2 d-flex align-items-center">
                                                    <div class="d-flex justify-content-center" style="width: 25px;">
                                                        <i class="bi bi-geo-alt-fill text-danger"></i>
                                                    </div>
                                                    <span class="ms-2">{{ vendor['VendorLocation'] or "Location not listed" }}</span>
                                                </li>

                                                <li class="mb-2 d-flex align-items-center">
                                                    <div class="d-flex justify-content-center" style="width: 25px;">
                                                        <i class="bi bi-telephone-fill text-success"></i>
                                                    </div>
                                                    <span class="ms-2">{{ vendor['VendorContactNumber'] or "No contact number" }}</span>
                                                </li>

                                                <li class="mb-2 d-flex align-items-center">
                                                    <div class="d-flex justify-content-center" style="width: 25px;">
                                                        <i class="bi bi-globe text-primary"></i>
                                                    </div>
                                                    <span class="ms-2">
                                                        {% if vendor['VendorWebsite'] %}
                                                            <a href="{{ vendor['VendorWebsite'] }}" target="_blank" class="text-decoration-none text-muted border-bottom border-secondary">
                                                                Visit Website
                                                            </a>
                                                        {% else %}
                                                            No website listed
                                                        {% endif %}
                                                    </span>
                                                </li>

                                                <li class="mb-2 d-flex align-items-center">
                                                    <div class="d-flex justify-content-center" style="width: 25px;">
                                                        <i class="bi bi-instagram text-danger"></i>
                                                    </div>
                                                    <span class="ms-2">
                                                        {% if vendor['VendorInstagram'] %}
                                                            <a href="{{ vendor['VendorInstagram'] }}" target="_blank" class="text-decoration-none text-muted border-bottom border-secondary">
                                                                Instagram Profile
                                                            </a>
                                                        {% else %}
                                                            No Instagram listed
                                                        {% endif %}
                                                    </span>
                                                </li>

                                                <li class="mb-2 d-flex align-items-center">
                                                    <div class="d-flex justify-content-center" style="width: 25px;">
                                                        <i class="bi bi-facebook text-primary"></i>
                                                    </div>
                                                    <span class="ms-2">
                                                        {% if vendor['VendorFacebook'] %}
                                                            <a href="{{ vendor['VendorFacebook'] }}" target="_blank" class="text-decoration-none text-muted border-bottom border-secondary">
                                                                Facebook Page
                                                            </a>
                                                        {% else %}
                                                            No Facebook listed
                                                        {% endif %}
                                                    </span>
                                                </li>

                                              </ul>
                                          </div>

                                          <div class="mt-3 pt-3 border-top d-flex gap-2">
                                              <button class="btn btn-outline-secondary btn-sm px-3 fw-semibold" data-bs-toggle="modal" data-bs-target="#editVendorModal">
                                                  <i class="bi bi-pencil-square me-2"></i> Edit Details
                                              </button>
                                          </div>

                                      </div>
                                  </div>
                                </div>

                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
                                        <h5 class="mb-0"><i class="bi bi-basket me-2"></i>Your Products</h5>
                                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                            <i class="bi bi-plus-lg me-1"></i> Add Product
                                        </button>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="ps-4">Product Name</th>
                                                        <th>Price (R)</th>
                                                        <th class="text-end pe-4" style="width: 150px;">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for product in vendor_products %}
                                                    <tr>
                                                        <td class="ps-4 fw-semibold">{{ product['ProductName'] }}</td>
                                                        <td>R {{ "%.2f"|format(product['ProductPrice']) }}</td>
                                                        <td class="text-end pe-4">
                                                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product['ProductID'] }}">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <form method="POST" class="d-inline">
                                                                <input type="hidden" name="action" value="delete_product">
                                                                <input type="hidden" name="product_id" value="{{ product['ProductID'] }}">
                                                                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this product?')">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="3" class="text-center py-4 text-muted">No products yet.</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Account Management Section -->
                                <div class="card mt-5 shadow-sm border-0">
                                <div class="card-header bg-secondary text-white py-3">
                                    <h5 class="mb-0 fw-semibold"><i class="bi bi-gear-fill me-2"></i>Account Management</h5>
                                </div>

                                <div class="card-body p-4">
                                    <div class="row g-4 align-items-center">
                                        
                                        <div class="col-lg-6">
                                            <h5 class="fw-bold text-dark">Role & Permissions</h5>
                                            <p class="text-muted mb-0">
                                                Manage your administrative access. You can upgrade your account to host events or remove your current vendor profile if you wish to stop selling.
                                            </p>
                                        </div>

                                        <div class="col-lg-6">
                                            <div class="d-flex flex-column gap-3">
                                                
                                                <div class="p-3 rounded bg-light border border-light-subtle d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="fw-bold text-dark mb-1">Create Market</h6>
                                                        <small class="text-muted d-block">Become an administrator.</small>
                                                    </div>
                                                    <a href="{{ url_for('market_request') }}" class="btn btn-dark btn-sm rounded-pill px-3">
                                                        Create Market
                                                    </a>
                                                </div>

                                                <div class="p-3 rounded bg-danger-subtle border border-danger-subtle d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="fw-bold text-danger mb-1">Vendor Profile</h6>
                                                        <small class="text-danger-emphasis d-block">Permanently delete data.</small>
                                                    </div>
                                                    
                                                    <form action="{{ url_for('userpage') }}" method="POST" onsubmit="return confirm('Are you sure? This will delete your products and vendor details permanently.');">
                                                        <input type="hidden" name="action" value="delete_vendor_profile">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    </form>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>
                                </div>
                            </div>

                        {# 2. MARKET ADMIN VIEW #}
                        {% elif user['Classification'] == 'MarketAdministrator' %}
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                                        <div>
                                            <h5 class="fw-bold text-success mb-1">
                                                {{ market['MarketName'] if market else 'Register Your Market' }}
                                            </h5>
                                            {% if market %}
                                                <small class="text-muted"><i class="bi bi-geo-alt-fill"></i> {{ market['MarketLocation'] }}</small>
                                            {% endif %}
                                        </div>
                                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#editMarketModal">
                                            <i class="bi bi-pencil-fill me-1"></i> {{ 'Edit' if market else 'Create' }}
                                        </button>
                                    </div>

                                    <div class="row g-3 text-center mb-4">
                                        <div class="col-12 mb-3">
                                            <div class="p-3 bg-light rounded"> <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">MARKET DESCRIPTION</small>
                                                <p class="mb-0 small text-dark">
                                                    {{ market['MarketDescription'] if market and market['MarketDescription'] else 'No description available.' }}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-light rounded">
                                                <h4 class="fw-bold text-dark mb-0">{{ events|length }}</h4>
                                                <small class="text-muted" style="font-size: 0.7rem;">EVENTS</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-light rounded text-center border">
                                                <h4 class="fw-bold text-dark mb-0">{{ vendors|length }}</h4>
                                                <small class="text-muted fw-bold" style="font-size: 0.7rem;">VENDORS</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-light rounded">
                                                <h4 class="fw-bold text-dark mb-0">{{ market['MarketEntryFee'] if market else '-' }}</h4>
                                                <small class="text-muted" style="font-size: 0.7rem;">ENTRY FEE</small>
                                            </div>
                                        </div>

                                        <div class="col-4 mb-3">
                                            <div class="p-2 bg-light rounded text-center h-100 d-flex flex-column justify-content-center">
                                                <h5 class="fw-bold text-dark mb-0 text-truncate">
                                                    {{ market['MarketDays'] if market and market['MarketDays'] else '-' }}
                                                </h5>
                                                <small class="text-muted" style="font-size: 0.7rem;">OPERATING DAYS</small>
                                            </div>
                                        </div>

                                        <div class="col-4 mb-3">
                                            <div class="p-2 bg-light rounded text-center h-100 d-flex flex-column justify-content-center">
                                                {% if market and market['MarketInstagram'] %}
                                                    <a href="{{ market['MarketInstagram'] if 'http' in market['MarketInstagram'] else 'https://instagram.com/' ~ market['MarketInstagram'] }}" target="_blank" class="text-danger h4 mb-0">
                                                        <i class="bi bi-instagram"></i>
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted h4 mb-0">-</span>
                                                {% endif %}
                                                <small class="text-muted" style="font-size: 0.7rem;">INSTAGRAM</small>
                                            </div>
                                        </div>

                                        <div class="col-4 mb-3">
                                            <div class="p-2 bg-light rounded text-center h-100 d-flex flex-column justify-content-center">
                                                {% if market and market['MarketFacebook'] %}
                                                    <a href="{{ market['MarketFacebook'] if 'http' in market['MarketFacebook'] else 'https://facebook.com/' ~ market['MarketFacebook'] }}" target="_blank" class="text-primary h4 mb-0">
                                                        <i class="bi bi-facebook"></i>
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted h4 mb-0">-</span>
                                                {% endif %}
                                                <small class="text-muted" style="font-size: 0.7rem;">FACEBOOK</small>
                                            </div>
                                        </div>

                                        <div class="col-6 mb-3">
                                            <div class="p-3 bg-light rounded text-center h-100 position-relative hover-shadow transition-all">
                                                {% if market and market['MarketPoster'] %}
                                                    <i class="bi bi-image h3 text-success d-block mb-1"></i>
                                                    
                                                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">POSTER</small>

                                                    <button type="button" class="btn stretched-link p-0" data-bs-toggle="modal" data-bs-target="#posterModal"></button>
                                                {% else %}
                                                    <i class="bi bi-image h3 text-muted d-block mb-1"></i>
                                                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">POSTER</small>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="col-6 mb-3">
                                            <div class="p-3 bg-light rounded text-center h-100 position-relative hover-shadow transition-all">
                                                {% if market and market['MarketMap'] %}
                                                    <i class="bi bi-map h3 text-warning d-block mb-1"></i>
                                                    
                                                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">MAP</small>

                                                    <button type="button" class="btn stretched-link p-0" data-bs-toggle="modal" data-bs-target="#mapModal"></button>
                                                {% else %}
                                                    <i class="bi bi-map h3 text-muted d-block mb-1"></i>
                                                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">MAP</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold">Your Events</h6>
                                        <a href="{{ url_for('Eventform') }}" class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-plus-lg"></i> Add
                                        </a>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Date</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if events %}
                                                    {% for event in events %}
                                                    <tr>
                                                        <td>{{ event['EventName'] }}</td>
                                                        <td>{{ event['EventDate'] }}</td>
                                                        <td>
                                                            <div class="d-flex gap-2">
                                                                <button class="btn btn-sm btn-light border" data-bs-toggle="modal" data-bs-target="#editEventModal{{ event['EventID'] }}">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>

                                                                <form action="{{ url_for('userpage') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this event?');">
                                                                    <input type="hidden" name="action" value="delete_event">
                                                                    <input type="hidden" name="event_id" value="{{ event['EventID'] }}">
                                                                    <button type="submit" class="btn btn-sm btn-outline-danger border">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </form>
                                                            </div>

                                                            <div class="modal fade" id="editEventModal{{ event['EventID'] }}" tabindex="-1" aria-hidden="true">
                                                                <div class="modal-dialog modal-dialog-centered">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header bg-success text-white">
                                                                            <h5 class="modal-title">Edit Event: {{ event['EventName'] }}</h5>
                                                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                                        </div>
                                                                        
                                                                        <form action="{{ url_for('userpage') }}" method="POST" enctype="multipart/form-data">
                                                                            <input type="hidden" name="action" value="update_event_details">
                                                                            <input type="hidden" name="event_id" value="{{ event['EventID'] }}">

                                                                            <div class="modal-body text-start">
                                                                                <div class="mb-3">
                                                                                    <label class="form-label fw-bold">Event Name</label>
                                                                                    <input type="text" class="form-control" name="event_name" value="{{ event['EventName'] }}" required>
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label fw-bold">Date</label>
                                                                                    <input type="date" class="form-control" name="event_date" value="{{ event['EventDate'] }}">
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label fw-bold">Days</label>
                                                                                    <input type="text" class="form-control" name="event_days" value="{{ event['EventDays'] }}">
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label fw-bold">Description</label>
                                                                                    <textarea class="form-control" name="event_description" rows="3">{{ event['EventDescription'] }}</textarea>
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label fw-bold">Booking Link</label>
                                                                                    <input type="text" class="form-control" name="booking_link" value="{{ event['EventBookingLink'] }}">
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label fw-bold">Update Poster</label>
                                                                                    <input type="file" class="form-control" name="event_poster">
                                                                                    <small class="text-muted">Leave empty to keep current poster.</small>
                                                                                </div>
                                                                            </div>
                                                                            <div class="modal-footer">
                                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                                <button type="submit" class="btn btn-success">Save Changes</button>
                                                                            </div>
                                                                        </form> 
                                                                        </div>
                                                                </div>
                                                            </div>
                                                            </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="3" class="text-center text-muted small">No events found.</td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Account Management Section -->
                                    <div class="card mt-5 shadow-sm border-0">
                                    <div class="card-header bg-secondary text-white py-3">
                                        <h5 class="mb-0 fw-semibold"><i class="bi bi-gear-fill me-2"></i>Account Management</h5>
                                    </div>

                                    <div class="card-body p-4">
                                        <div class="row g-4 align-items-center">
                                            
                                            <div class="col-lg-6">
                                                <h5 class="fw-bold text-dark">Role & Permissions</h5>
                                                <p class="text-muted mb-0">
                                                    Manage your administrative access. You can upgrade your account to host events or remove your current vendor profile if you wish to stop selling.
                                                </p>
                                            </div>

                                            <div class="col-lg-6">
                                                <div class="d-flex flex-column gap-3">                                                   
                                                    <div class="p-3 rounded bg-danger-subtle border border-danger-subtle d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="fw-bold text-danger mb-1">Market Profile</h6>
                                                            <small class="text-danger-emphasis d-block">Permanently delete data.</small>
                                                        </div>
                                                        
                                                        <form action="{{ url_for('userpage') }}" method="POST" onsubmit="return confirm('WARNING: This will permanently delete your Market Page and ALL associated Events. Are you sure?');">
                                                            <input type="hidden" name="action" value="delete_market_profile">
                                                            
                                                            <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                                                                <i class="bi bi-trash"></i> Delete
                                                            </button>
                                                        </form>
                                                    </div>

                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>

                        {# 3. STANDARD USER VIEW #}
                        {% else %}
                            <div class="card bg-success text-white border-0 shadow-sm">
                                <div class="card-body p-4 bg-gradient rounded d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="fw-bold mb-1">Welcome back!</h3>
                                        <p class="mb-0 opacity-75">Explore local markets today.</p>
                                    </div>
                                    <i class="bi bi-basket2-fill d-none d-md-block" style="font-size: 3rem; opacity: 0.5;"></i>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-body p-3 d-flex align-items-center">
                                            <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle me-3">
                                                <i class="bi bi-map-fill fs-4"></i>
                                            </div>
                                            <div>
                                                <h6 class="fw-bold mb-0">Find Markets</h6>
                                                <a href="{{ url_for('home') }}" class="stretched-link text-muted small">Browse locations</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-body p-3 d-flex align-items-center">
                                            <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-circle me-3">
                                                <i class="bi bi-calendar-check-fill fs-4"></i>
                                            </div>
                                            <div>
                                                <h6 class="fw-bold mb-0">Events</h6>
                                                <a href="{{ url_for('events') }}" class="stretched-link text-muted small">What's on?</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white border-0 pt-3 pb-0">
                                    <h6 class="fw-bold mb-0">Join the Economy</h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="row g-3">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                                                    <div class="card-body p-4 text-center">
                                                        
                                                        <div class="d-inline-flex align-items-center justify-content-center bg-success-subtle text-success rounded-circle mb-3" style="width: 60px; height: 60px;">
                                                            <i class="bi bi-shop fs-3"></i>
                                                        </div>

                                                        <h5 class="fw-bold text-dark">Become a Vendor</h5>
                                                        <p class="text-muted small mb-4">
                                                            Register your stall, manage products, and start selling.
                                                        </p>
                                                        
                                                        <a href="{{ url_for('vendor_request') }}" class="btn btn-outline-success rounded-pill px-4 stretched-link">
                                                            Register Stall
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                                                    <div class="card-body p-4 text-center">
                                                        
                                                        <div class="d-inline-flex align-items-center justify-content-center bg-dark-subtle text-dark rounded-circle mb-3" style="width: 60px; height: 60px;">
                                                            <i class="bi bi-buildings fs-3"></i>
                                                        </div>

                                                        <h5 class="fw-bold text-dark">Create Market</h5>
                                                        <p class="text-muted small mb-4">
                                                            Become an administrator and host your own events.
                                                        </p>
                                                        
                                                        <a href="{{ url_for('market_request') }}" class="btn btn-outline-dark rounded-pill px-4 stretched-link">
                                                            Create Market
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        {# --- LOGIC END --- #}

                    </div>
                </div>

            </div>
        </div>
      </div>
    </main>

    <div class="modal fade" id="editUsernameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Username</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('userpage') }}" method="POST">
              <input type="hidden" name="action" value="update_username">
                <div class="modal-body">
                    <input type="text" class="form-control" name="username" value="{{ user['Username'] }}" required>
                </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
    </div>

    <div class="modal fade" id="editEmailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Email</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form action="{{ url_for('userpage') }}" method="POST">
            <input type="hidden" name="action" value="update_email">
              <div class="modal-body">
                  <input type="email" class="form-control" name="email" value="{{ user['Email'] }}" required>
              </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editPasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Change Password</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('userpage') }}" method="POST">
              <input type="hidden" name="action" value="update_password">
              <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-control" name="current_password" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-control" name="new_password" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Update</button>
              </div>
            </form>
          </div>
        </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <form action="{{ url_for('userpage') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="add_product">
            
            <div class="mb-3">
              <label for="pName" class="form-label">Product Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="pName" name="product_name" required>
            </div>

            <div class="mb-3">
              <label for="pPrice" class="form-label">Price (R) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="pPrice" name="product_price" step="0.01" required>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-success">Save Product</button>
            </div>
          </form>
        </div>

      </div>
    </div>
    </div>

    <div class="modal fade" id="editMarketModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Edit Market Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <form action="{{ url_for('userpage') }}" method="POST" enctype="multipart/form-data"> 
                    <input type="hidden" name="action" value="update_market">
                    
                    <div class="modal-body">
                        <div class="row g-3">
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Market Name</label>
                                <input type="text" class="form-control" name="market_name" value="{{ market['MarketName'] if market }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Physical Location</label>
                                <input type="text" class="form-control" name="market_location" value="{{ market['MarketLocation'] if market }}">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Location Link (Google Maps)</label>
                                <input type="url" class="form-control" name="location_link" placeholder="https://maps.google.com/..." value="{{ market['MarketLocationLink'] if market }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Entry Fee</label>
                                <div class="input-group">
                                    <span class="input-group-text">R</span>
                                    <input type="text" class="form-control" name="entry_fee" value="{{ market['MarketEntryFee'] if market }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Operating Days</label>
                                <input type="text" class="form-control" name="market_days" placeholder="e.g. Saturdays, First Sunday" value="{{ market['MarketDays'] if market }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Instagram Handle/Link</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-instagram"></i></span>
                                    <input type="text" class="form-control" name="instagram" value="{{ market['MarketInstagram'] if market }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Facebook Handle/Link</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-facebook"></i></span>
                                    <input type="text" class="form-control" name="facebook" value="{{ market['MarketFacebook'] if market }}">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Description</label>
                                <textarea class="form-control" name="market_description" rows="3">{{ market['MarketDescription'] if market }}</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Update Poster</label>
                                <input type="file" class="form-control" name="market_poster" accept="image/*">
                                <small class="text-muted">Leave empty to keep current.</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Update Map</label>
                                <input type="file" class="form-control" name="market_map" accept="image/*">
                                <small class="text-muted">Leave empty to keep current.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Add/Edit Event</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="" method="POST" enctype="multipart/form-data"> 
                <input type="hidden" name="action" value="update_event">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Event Name</label>
                        <input type="text" class="form-control" name="event_name" required>
                    </div>
                    <div class="row g-3">
                         <div class="col-6">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="event_date">
                         </div>
                         <div class="col-6">
                             <label class="form-label">Duration</label>
                             <input type="text" class="form-control" name="event_days">
                         </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Save Event</button>
                </div>
            </form>
        </div>
        </div>
    </div>

    <div class="modal fade" id="editVendorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-shop me-2"></i>Edit Vendor Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form action="{{ url_for('userpage') }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="update_vendor">
                    
                    <div class="modal-body p-4">
                        
                        <h6 class="text-muted text-uppercase fw-bold small mb-3">Images</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Profile Logo</label>
                                <input type="file" class="form-control" name="vendor_logo" accept="image/*">
                                <div class="form-text text-muted small">Square images work best.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Stall Banner / Feature Image</label>
                                <input type="file" class="form-control" name="description_picture" accept="image/*">
                                <div class="form-text text-muted small">Displayed in your "About" section.</div>
                            </div>
                        </div>

                        <hr class="my-3 opacity-10">

                        <h6 class="text-muted text-uppercase fw-bold small mb-3">Stall Details</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Vendor / Stall Name</label>
                                <input type="text" class="form-control" name="vendor_name" value="{{ vendor['VendorName'] }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Offering Type</label>
                                <select class="form-select" name="vendor_type">
                                    <option value="Food & Drink" {% if vendor['VendorOfferingType'] == 'Food & Drink' %}selected{% endif %}>Food & Drink</option>
                                    <option value="Arts & Crafts" {% if vendor['VendorOfferingType'] == 'Arts & Crafts' %}selected{% endif %}>Arts & Crafts</option>
                                    <option value="Clothing" {% if vendor['VendorOfferingType'] == 'Clothing' %}selected{% endif %}>Clothing</option>
                                    <option value="Services" {% if vendor['VendorOfferingType'] == 'Services' %}selected{% endif %}>Services</option>
                                    <option value="Other" {% if vendor['VendorOfferingType'] == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Location</label>
                                <input type="text" class="form-control" name="vendor_location" value="{{ vendor['VendorLocation'] or '' }}" placeholder="E.g. Stall 42, Main Tent or Street Address">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">Description</label>
                                <textarea class="form-control" name="vendor_description" rows="3" placeholder="Tell customers what makes your stall special...">{{ vendor['VendorStallDescription'] or '' }}</textarea>
                            </div>
                        </div>

                        <hr class="my-3 opacity-10">

                        <h6 class="text-muted text-uppercase fw-bold small mb-3">Contact & Links</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="bi bi-whatsapp text-success"></i> Contact Number</label>
                                <input type="text" class="form-control" name="contact_number" value="{{ vendor['VendorContactNumber'] or '' }}" placeholder="012 345 6789">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="bi bi-globe text-primary"></i> Website</label>
                                <input type="url" class="form-control" name="website" value="{{ vendor['VendorWebsite'] or '' }}" placeholder="https://mywebsite.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="bi bi-instagram text-danger"></i> Instagram</label>
                                <input type="url" class="form-control" name="instagram" value="{{ vendor['VendorInstagram'] or '' }}" placeholder="https://instagram.com/...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="bi bi-facebook text-primary"></i> Facebook</label>
                                <input type="url" class="form-control" name="facebook" value="{{ vendor['VendorFacebook'] or '' }}" placeholder="https://facebook.com/...">
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success px-4">Save Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteProfileModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">Delete Account?</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold">Are you sure you want to delete your profile?</p>
                    <p class="text-muted small">This action cannot be undone. All your data, saved markets, and settings will be permanently removed.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    
                    <!-- The Form that actually sends the delete command -->
                    <form action="{{ url_for('delete_profile') }}" method="POST">
                        <button type="submit" class="btn btn-danger">Yes, Delete My Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editMarketModal" tabindex="-1">
      <div class="modal-dialog">
          <div class="modal-content">
              
              <form method="POST" action="/update_market" enctype="multipart/form-data">
                  
                  <div class="modal-header bg-success text-white">
                      <h5 class="modal-title">
                          <i class="bi bi-shop me-2"></i>Manage Market Details
                      </h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                      
                      <div class="mb-3">
                          <label class="form-label fw-bold">Market Name</label>
                          <input type="text" class="form-control" name="market_name" 
                                value="{{ market['MarketName'] if market else '' }}" required>
                      </div>

                      <div class="mb-3">
                          <label class="form-label fw-bold">Location</label>
                          <input type="text" class="form-control" name="market_location" 
                                value="{{ market['MarketLocation'] if market else '' }}" required>
                      </div>

                      <div class="mb-3">
                          <label class="form-label fw-bold">Entry Fee (R)</label>
                          <input type="number" step="0.01" class="form-control" name="entry_fee" 
                                value="{{ market['MarketEntryFee'] if market else '0.00' }}">
                      </div>

                      <div class="mb-3">
                          <label class="form-label fw-bold">Market Logo</label>
                          <input type="file" class="form-control" name="market_logo" accept="image/*">
                          <div class="form-text text-muted">Leave blank to keep current logo.</div>
                      </div>

                  </div>

                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success">Save Changes</button>
                  </div>

              </form>
          </div>
      </div>
    </div>

    <div class="modal fade" id="posterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Market Poster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                {% if market and market['MarketPoster'] %}
                    <img src="data:image/png;base64,{{ market['MarketPoster'] | b64encode }}" class="img-fluid rounded" alt="Poster">
                {% endif %}
            </div>
        </div>
    </div>
    </div>

    <div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Market Map</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    {% if market and market['MarketMap'] %}
                        <img src="data:image/png;base64,{{ market['MarketMap'] | b64encode }}" class="img-fluid rounded" alt="Map">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>